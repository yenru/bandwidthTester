<!DOCTYPE html>
<html>
<head>
    <title>四季頻寬測試</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=on">
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/1.5/canvg.min.js"></script>
    <script src="//unpkg.com/jspdf@latest/dist/jspdf.min.js"></script>
<script>
var getRequest = function() {
	var obj = {};
	var uri = location.search;
	if(uri) {
		var name = uri.replace('?', '').split("&");
		for (var i = 0; i < name.length; i++) {
			obj[name[i].split('=')[0]] = name[i].split('=')[1] || '';
		}
		return obj;
	}
	return null;
};
function calcAverage(num1,num2){
    if(num2 == 0){
        return num1;
    }else if(num1 == 0){
        return num2;
    }else{
        return ((parseFloat(num1)+parseFloat(num2))/2).toFixed(2)
    }
}
</script>
</head>
<body>

    <h1>四季線上影視測速工具</h1>
    <p id="statusMsg"></p>
    <div id="speed-graph" style="height: 250px;"></div>
    <div id="buttonBar">
        <button id="startBtn">開始測速</button>
        <button id="stopBtn">停止測速</button>
        <button id="downloadBtn">下載結果</button>
    </div>
    <br /><canvas id="canvas"></canvas>

<script>
(function() {
    var speedStatus = 0;    //0:關閉中; 1:開啟中
    var $startBtn = $("#startBtn");
    var $stopBtn = $("#stopBtn");
    var $statusMsg = $("#statusMsg");
    var $downloadBtn = $("#downloadBtn");

    /** Chart Data init **/
    var chartData;
    function initData() {
        chartData = [];
        chartData.push({
            x: new Date().getTime(),
            y: '0'
        });
    }
    initData();
    
    /** Morris Chart **/
    var speedGraph = Morris.Line({
        element: 'speed-graph',
        data: chartData,
        xkey: 'x',
        ykeys: ['y'],
        labels: ['Response time'],
        parseTime: true,
        ymin: 'auto',
        ymax: 'auto',
        postUnits: ' s',
        hideHover: true
    });

    $startBtn.click(function(e){
        $startBtn.hide();
        $stopBtn.show();
        initData();
        speedGraph.setData(chartData);

        $statusMsg.text("開始測速。第一次下載可能速度較慢，請耐心等候。");
        speedStatus = 1;
        TestResponse();
        $downloadBtn.hide();
    });
    $stopBtn.click(testStop);
    function testStop() {
        speedStatus = 0;
        $startBtn.show();
        $stopBtn.hide();
        if(chartData.length > 1) {
            $statusMsg.text("測試結束。");
            $downloadBtn.show();
        }
        else {
            $statusMsg.text("沒有下載任何檔案，請耐心等候一段時間。");
        }
    };
    $downloadBtn.click(function(e){
        var svg = $("#speed-graph").html();
        var canvas = document.getElementById('canvas');
        canvg(canvas, svg.split("<div")[0]);

        var imgData = canvas.toDataURL('image/png');
        var doc = new jsPDF('l', 'mm');
        doc.addImage(imgData, 'PNG', 10, 10);
        doc.save('speedtest-result.pdf');
    });
    
    // var fileSize = 10503578;
    function TestResponse() {
        var sendDate = Date.now();
        const request = new Request('http://test-cds.cdn.hinet.net/test_010m.zip', {cache: "no-store"});

        fetch(request).then(res => res.blob().then(blob => {
            var receiveDate = Date.now();
            var response = receiveDate - sendDate;

            testCallback(response);
        }))
        .catch(function(err) {
            testStop();
            $statusMsg.html("<span class=\"error\">發生錯誤，請參考錯誤訊息："+err.message+"<span>");
        });
    }

    function testCallback(val) {
        if(speedStatus == 1) {
            TestResponse();
            chartData.push({
                x: new Date().getTime(),
                y: (val / 1000).toFixed(2)
            });
            speedGraph.setData(chartData);
        }
    }
})();
</script>

</body>
</html>
